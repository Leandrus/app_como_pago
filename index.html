<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora de Pagos VE</title>

    <!-- --- PWA CONFIGURATION START --- -->
    <!-- Indica al navegador que puede ser instalada (Android) -->
    <link rel="manifest" href="manifest.json">
    <!-- Define el color de la barra de título del navegador/estado de la app -->
    <meta name="theme-color" content="#0f172a">

    <!-- Configuraciones específicas para iOS (Apple) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CalcVE">
    <!-- En un entorno real, aquí se añadirían los enlaces a los iconos de iOS (ej: 180x180) -->
    <!-- --- PWA CONFIGURATION END --- -->

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
        }
        /* Eliminar flechas de input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .card {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155;
            border-radius: 12px;
        }
        .input-dark {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: white;
            transition: all 0.2s;
        }
        .input-dark:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        /* Estilo especial para campos editables principales (Tasas) */
        .input-editable {
            background-color: rgba(30, 41, 59, 0.5);
            border: 1px dashed #475569;
            color: white;
            transition: all 0.2s;
            cursor: text;
        }
        .input-editable:focus {
            background-color: #0f172a;
            border-color: #3b82f6;
            border-style: solid;
            outline: none;
        }
        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #2563eb);
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        /* Estilos para el nuevo input 2-en-1 */
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        .input-group input {
            text-align: center;
            height: 48px;
        }
        /* Colores actualizados para los pares de inputs */
        .input-usd-green {
             color: #34d399; /* emerald-400 (verde) */
             font-weight: 700;
        }
        .input-ves-yellow {
            color: #fcd34d; /* yellow-300 (amarillo) */
            font-weight: 700;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <main class="w-full max-w-md space-y-4">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-2xl font-bold text-blue-400">Calculadora de Pagos</h1>
            <p class="text-xs text-slate-400 mt-1">Ingresa tus tasas y compara costos automáticamente.</p>
        </header>

        <!-- Sección de Tasas (Rates) -->
        <section class="grid grid-cols-2 gap-3">
            <!-- BCV (TASA OFICIAL - Verde) -->
            <div class="card p-3 flex flex-col justify-between relative group">
                <div class="flex justify-between items-center">
                    <!-- Título limpiado -->
                    <span class="text-xs font-semibold tracking-wider text-green-400">TASA OFICIAL</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-slate-500 opacity-50 group-hover:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </div>
                <div class="flex items-baseline mt-1">
                    <!-- Color verde aplicado al Bs. y al input -->
                    <span class="text-lg font-bold text-green-400 mr-1">Bs.</span>
                    <input type="number" step="0.01" id="bcvDisplay" class="input-editable w-full text-xl font-bold rounded px-1 focus:outline-none text-green-400" placeholder="0.00">
                </div>
                <div id="bcvLoader" class="absolute top-3 right-3 opacity-0 animate-spin h-3 w-3 border-2 border-blue-500 rounded-full border-t-transparent transition-opacity duration-300"></div>
            </div>

            <!-- USDT (TASA BINANCE - Amarillo) -->
            <div class="card p-3 flex flex-col justify-between relative group">
                <div class="flex justify-between items-center">
                    <!-- Título limpiado -->
                    <span class="text-xs font-semibold tracking-wider text-yellow-400">TASA BINANCE</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-slate-500 opacity-50 group-hover:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </div>
                <div class="flex items-baseline mt-1">
                    <!-- Color amarillo aplicado al Bs. y al input -->
                    <span class="text-lg font-bold text-yellow-400 mr-1">Bs.</span>
                    <input type="number" step="0.01" id="usdtDisplay" class="input-editable w-full text-xl font-bold rounded px-1 focus:outline-none text-yellow-400" placeholder="0.00">
                </div>
                 <div id="usdtLoader" class="absolute top-3 right-3 opacity-0 animate-spin h-3 w-3 border-2 border-blue-500 rounded-full border-t-transparent transition-opacity duration-300"></div>
            </div>
        </section>

        <!-- Diferencia de Tasas -->
        <div class="text-center text-xs text-slate-500">
            Diferencia BCV vs P2P: <span id="rateDiff">Calculando...</span>
        </div>

        <!-- Tasa Promedio Calculada (Editable) -->
        <section class="card p-4 border-blue-500/30 shadow-[0_0_15px_rgba(59,130,246,0.1)]">
            <div class="flex justify-between items-center mb-2">
                <!-- Título actualizado -->
                <label for="avgRateInput" class="text-sm font-medium text-blue-300">Tasa Promedio</label>
                <!-- FÓRMULA ACTUALIZADA -->
                <span class="text-[10px] bg-blue-900/50 text-blue-200 px-2 py-1 rounded">Fórmula: ((BCV + P2P) / 2) + 10%</span>
            </div>
            <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">Bs.</span>
                <input type="number" step="0.01" id="avgRateInput" class="input-dark w-full p-3 pl-10 rounded-lg text-xl font-bold text-center" placeholder="0.00">
            </div>
            <!-- Comentario del texto de ayuda -->
            <!-- <p class="text-[10px] text-slate-500 mt-2 text-center">Edita este campo si deseas anular la fórmula y usar un valor fijo para el cálculo.</p> -->
        </section>

        <hr class="border-slate-700 my-2">

        <!-- Inputs de Precios CONVERSIÓN BCV vs PROMEDIO -->
        <section class="space-y-3">
            
            <!-- Opción 1: Conversión usando Tasa BCV (Precio de compra, pagando en Bolivares (BCV) - Verde) -->
            <div>
                <!-- Título limpiado -->
                <label class="block text-xs mb-1 ml-1 font-semibold text-green-400">Precio de compra, pagando en Bolivares (BCV)</label>
                <div class="input-group">
                    <!-- Campo USD (Principal - Color verde) -->
                    <div class="relative">
                        <input type="number" id="price_bcv_usd_input" class="input-dark input-usd-green w-full p-3 rounded-lg text-lg" placeholder="0.00">
                        <!-- Símbolo $ con color verde -->
                        <span class="absolute left-1 top-1/2 -translate-y-1/2 font-bold text-sm text-green-400">$</span>
                    </div>
                    <!-- Campo VES (Convertido con BCV - Color verde) -->
                    <div class="relative">
                        <input type="number" id="price_bcv_ves_input" class="input-dark w-full p-3 rounded-lg text-lg text-green-400 font-bold" placeholder="0.00">
                        <!-- Símbolo Bs. con color verde -->
                        <span class="absolute right-1 top-1/2 -translate-y-1/2 font-bold text-sm text-green-400">Bs.</span>
                    </div>
                </div>
            </div>

            <!-- Opción 2: Conversión usando Tasa PROMEDIO (Precio de compra, pagando en Dolares Fisicos - Amarillo) -->
            <div>
                <!-- Título limpiado -->
                <label class="block text-xs mb-1 ml-1 font-semibold text-yellow-400">Precio de compra, pagando en Dolares Fisicos</label>
                <div class="input-group">
                    <!-- Campo USD (Convertido con Promedio - Color amarillo) -->
                    <div class="relative">
                        <input type="number" id="price_avg_usd_input" class="input-dark w-full p-3 rounded-lg text-lg text-yellow-400 font-bold" placeholder="0.00">
                        <!-- Símbolo $ con color amarillo -->
                        <span class="absolute left-1 top-1/2 -translate-y-1/2 font-bold text-sm text-yellow-400">$</span>
                    </div>
                    <!-- Campo VES (Principal - Color amarillo) -->
                    <div class="relative">
                        <input type="number" id="price_avg_ves_input" class="input-dark input-ves-yellow w-full p-3 rounded-lg text-lg" placeholder="0.00">
                        <!-- Símbolo Bs. con color amarillo -->
                        <span class="absolute right-1 top-1/2 -translate-y-1/2 font-bold text-sm text-yellow-400">Bs.</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Resultado del Análisis -->
        <section id="resultCard" class="hidden">
            <div class="card p-4 bg-slate-800/50 border-t-4 border-slate-600 transition-all duration-300" id="recommendationBox">
                <h2 class="text-lg font-bold text-center mb-2 text-white">Análisis de Conveniencia</h2>
                
                <!-- Nuevo párrafo para "Pagar en:" -->
                <p class="text-center text-sm text-slate-300">Pagar en:</p>
                
                <!-- Div reubicado (antes estaba al final del box) -->
                <div class="text-center py-2 px-4 rounded-lg font-bold text-lg animate-pulse mb-3" id="finalVerdict">
                    ...
                </div>
                
                <!-- Este es el párrafo que ahora contendrá el detalle de ahorro -->
                <p class="text-center text-xs text-slate-400 mt-2 font-semibold" id="savingsText"></p>
            </div>
        </section>

        <!-- Botón Reiniciar -->
        <button id="btnReset" class="w-full py-4 rounded-xl font-bold text-white btn-primary shadow-lg mt-4 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            Refrescar Tasas / Reiniciar Valores
        </button>
        
        <!-- Párrafo de nota técnica comentado -->
        <!-- <p class="text-[10px] text-slate-600 text-center mt-4">
            **NOTA TÉCNICA:** Los valores se **guardan automáticamente** en la memoria local de tu navegador.
        </p> -->

    </main>

    <script>
        // --- Constantes de Local Storage ---
        const LS_KEY = 've_payment_calculator_state';

        // --- Estado Global ---
        const state = {
            bcv: 0,
            usdt: 0, 
            avgRate: 0,
            manualOverrideAvg: false, 
            
            // Nuevos estados persistentes
            price_bcv_usd: 0, 
            price_avg_ves: 0,
        };

        // Elementos del DOM
        const els = {
            bcvDisplay: document.getElementById('bcvDisplay'),
            usdtDisplay: document.getElementById('usdtDisplay'),
            bcvLoader: document.getElementById('bcvLoader'),
            usdtLoader: document.getElementById('usdtLoader'),
            rateDiff: document.getElementById('rateDiff'),
            avgRateInput: document.getElementById('avgRateInput'),
            
            // Pares de input bidireccionales
            price_bcv_usd_input: document.getElementById('price_bcv_usd_input'),
            price_bcv_ves_input: document.getElementById('price_bcv_ves_input'),
            price_avg_usd_input: document.getElementById('price_avg_usd_input'),
            price_avg_ves_input: document.getElementById('price_avg_ves_input'),
            
            resultCard: document.getElementById('resultCard'),
            recommendationBox: document.getElementById('recommendationBox'),
            finalVerdict: document.getElementById('finalVerdict'),
            savingsText: document.getElementById('savingsText'),
            btnReset: document.getElementById('btnReset')
        };
        
        // --- Lógica de Persistencia Local (LocalStorage) ---

        // Guarda el estado actual en localStorage
        let saveTimeout;
        const DEBOUNCE_TIME = 800;

        function saveState() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const dataToSave = {
                    bcv: parseFloat(els.bcvDisplay.value) || 0,
                    usdt: parseFloat(els.usdtDisplay.value) || 0,
                    avgRate: parseFloat(els.avgRateInput.value) || 0,
                    price_bcv_usd: parseFloat(els.price_bcv_usd_input.value) || 0, 
                    price_avg_ves: parseFloat(els.price_avg_ves_input.value) || 0, 
                    manualOverrideAvg: state.manualOverrideAvg
                };
                try {
                    localStorage.setItem(LS_KEY, JSON.stringify(dataToSave));
                } catch (e) {
                    console.error("Error al guardar en LocalStorage:", e);
                }
            }, DEBOUNCE_TIME);
        }

        // Carga el estado desde localStorage y lo aplica
        function loadSavedState() {
            let dataLoaded = false;
            try {
                const savedData = localStorage.getItem(LS_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // 1. Cargar Tasas y Flags
                    state.manualOverrideAvg = data.manualOverrideAvg === true;
                    
                    // Usamos la propiedad 'value' para cargar la UI
                    els.bcvDisplay.value = (data.bcv || 0).toFixed(2);
                    els.usdtDisplay.value = (data.usdt || 0).toFixed(2);
                    els.avgRateInput.value = (data.avgRate || 0).toFixed(2); 

                    // 2. Cargar Precios (Sólo el valor primario guardado)
                    els.price_bcv_usd_input.value = (data.price_bcv_usd > 0) ? data.price_bcv_usd.toFixed(2) : '';
                    els.price_avg_ves_input.value = (data.price_avg_ves > 0) ? data.price_avg_ves.toFixed(2) : '';
                    
                    dataLoaded = true;
                }
            } catch (e) {
                console.error("Error al cargar desde LocalStorage:", e);
            }
            // Después de cargar (o no) forzar recalculo basado en los valores en la UI
            updateDiff();
            recalculateAvg(true); 
            updateConversions(); 
            return dataLoaded;
        }
        
        // --- Funciones de API y UI ---

        async function fetchWithRetry(url, options = {}, retries = 3) {
            let delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Error final en fetch:", error);
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        async function fetchRates() {
            showLoaders(true);
            
            // Usar los valores cargados localmente (si existen) o fallbacks por defecto.
            let bcvVal = parseFloat(els.bcvDisplay.value) || 36.50; 
            let usdtVal = parseFloat(els.usdtDisplay.value) || 38.00; 

            const apiUrl = 'https://ve.dolarapi.com/v1/dolares'; 

            try {
                const data = await fetchWithRetry(apiUrl);
                
                // Buscar BCV (oficial)
                const oficialRate = data.find(item => item.fuente === 'oficial');
                // Buscar P2P (paralelo)
                const paraleloRate = data.find(item => item.fuente === 'paralelo');

                if (oficialRate && oficialRate.promedio) {
                    bcvVal = parseFloat(oficialRate.promedio);
                    console.log("BCV obtenido de API:", bcvVal);
                } else {
                    console.warn("API: No se encontró la tasa 'oficial'. Usando valor local/fallback.");
                }
                
                if (paraleloRate && paraleloRate.promedio) {
                    usdtVal = parseFloat(paraleloRate.promedio);
                    console.log("P2P obtenido de API:", usdtVal);
                } else {
                    console.warn("API: No se encontró la tasa 'paralelo'. Usando valor local/fallback.");
                }
            } catch (error) {
                console.error("Error obteniendo tasas del API. Usando valores guardados localmente o de fallback.", error);
                // Si falla, bcvVal y usdtVal conservan los valores cargados en loadSavedState()
            } finally {
                state.bcv = bcvVal;
                state.usdt = usdtVal;
                
                // Actualizar UI con los valores finales (API si exitoso, sino local/fallback)
                els.bcvDisplay.value = state.bcv.toFixed(2);
                els.usdtDisplay.value = state.usdt.toFixed(2);
                
                showLoaders(false);
                updateDiff();
                recalculateAvg();
                updateConversions(); 
                saveState(); // Guardar las tasas finales
            }
        }

        function showLoaders(show) {
            const opacity = show ? '1' : '0';
            els.bcvLoader.style.opacity = opacity;
            els.usdtLoader.style.opacity = opacity;
        }

        function updateDiff() {
            const bcv = parseFloat(els.bcvDisplay.value) || 0;
            const usdt = parseFloat(els.usdtDisplay.value) || 0;
            
            const diff = usdt - bcv;
            const diffPerc = bcv > 0 ? (diff / bcv) * 100 : 0;
            
            let colorClass = 'text-slate-500';
            if (diffPerc > 5) {
                colorClass = 'text-red-400';
            } else if (diffPerc > 1) {
                colorClass = 'text-orange-400';
            } else {
                colorClass = 'text-green-400';
            }
            
            // Aplicar la clase de color a la diferencia en Bs. Y al porcentaje.
            els.rateDiff.innerHTML = `
                <span class="${colorClass} font-bold">${diff.toFixed(2)} Bs</span> 
                <span class="text-slate-500">(</span>
                <span class="${colorClass} font-bold">${diffPerc.toFixed(2)}%</span>
                <span class="text-slate-500">)</span>
            `;
        }

        // --- Lógica de Cálculo y Conversión Bidireccional ---
        
        function recalculateAvg(forceRecalculate = false) {
            // Si el modo manual está activado y no se fuerza el recalculo, salimos.
            if (state.manualOverrideAvg && !forceRecalculate) {
                return; 
            }

            const currentBcv = parseFloat(els.bcvDisplay.value) || 0;
            const currentUsdt = parseFloat(els.usdtDisplay.value) || 0;

            // FÓRMULA ACTUALIZADA: ((BCV + P2P) / 2) * 1.10
            const simpleAvg = (currentBcv + currentUsdt) / 2;
            const rawAvg = simpleAvg * 1.10; // + 10%
            
            state.avgRate = Math.round((rawAvg + Number.EPSILON) * 100) / 100;
            
            els.avgRateInput.value = state.avgRate.toFixed(2);
            updateConversions(null, true); 
        }
        
        // Convierte y actualiza los pares de inputs bidireccionales
        function updateConversions(triggerId = null, skipSave = false) {
            const currentBcvRate = parseFloat(els.bcvDisplay.value);
            const currentAvgRate = parseFloat(els.avgRateInput.value);

            // Verificar que las tasas sean válidas
            if (isNaN(currentBcvRate) || currentBcvRate <= 0 || isNaN(currentAvgRate) || currentAvgRate <= 0) {
                 analyzePayment();
                 return;
            }
            
            let val;
            
            // --- PAR BCV (Oficial) ---
            if (triggerId === 'price_bcv_usd_input') {
                // Entrada: USD -> Calcula VES (usando BCV)
                val = parseFloat(els.price_bcv_usd_input.value) || 0;
                els.price_bcv_ves_input.value = val > 0 ? (val * currentBcvRate).toFixed(2) : '';
            } else if (triggerId === 'price_bcv_ves_input') {
                // Entrada: VES -> Calcula USD (usando BCV)
                val = parseFloat(els.price_bcv_ves_input.value) || 0;
                els.price_bcv_usd_input.value = val > 0 ? (val / currentBcvRate).toFixed(2) : '';
            } else {
                // Recalcular BCV basado en el campo USD (si no hay trigger)
                val = parseFloat(els.price_bcv_usd_input.value) || 0;
                els.price_bcv_ves_input.value = val > 0 ? (val * currentBcvRate).toFixed(2) : '';
            }

            // --- PAR PROMEDIO (Cálculo) ---
            if (triggerId === 'price_avg_ves_input') {
                // Entrada: VES -> Calcula USD (usando Promedio)
                val = parseFloat(els.price_avg_ves_input.value) || 0;
                els.price_avg_usd_input.value = val > 0 ? (val / currentAvgRate).toFixed(2) : '';
            } else if (triggerId === 'price_avg_usd_input') {
                // Entrada: USD -> Calcula VES (usando Promedio)
                val = parseFloat(els.price_avg_usd_input.value) || 0;
                els.price_avg_ves_input.value = val > 0 ? (val * currentAvgRate).toFixed(2) : '';
            } else {
                 // Recalcular Promedio basado en el campo VES (si no hay trigger)
                val = parseFloat(els.price_avg_ves_input.value) || 0;
                els.price_avg_usd_input.value = val > 0 ? (val / currentAvgRate).toFixed(2) : '';
            }

            // Después de la conversión, ejecutar el análisis y guardar
            analyzePayment();
            if (!skipSave) {
                saveState();
            }
        }


        function analyzePayment() {
            // Opción BCV (Costo en VES calculado usando Tasa BCV)
            const optionBcv_Ves = parseFloat(els.price_bcv_ves_input.value);
            const optionBcv_Usd = parseFloat(els.price_bcv_usd_input.value);
            
            // Opción Promedio (Costo en VES calculado usando Tasa Promedio)
            const optionAvg_Ves = parseFloat(els.price_avg_ves_input.value);
            const optionAvg_Usd = parseFloat(els.price_avg_usd_input.value);
            
            // Solo analizar si ambas opciones tienen valor > 0
            if (isNaN(optionBcv_Ves) || isNaN(optionAvg_Ves) || optionBcv_Ves === 0 || optionAvg_Ves === 0) {
                els.resultCard.classList.add('hidden');
                return;
            }

            els.resultCard.classList.remove('hidden');

            const box = els.recommendationBox;
            const verdict = els.finalVerdict;
            const savings = els.savingsText;

            // Resetear clases
            box.className = 'card p-4 bg-slate-800/50 border-t-4 transition-all duration-300';
            verdict.classList.remove('text-green-400', 'text-blue-400', 'animate-pulse', 'text-white', 'text-yellow-400');
            
            // Calculo de diferencias (siempre positivo)
            const diffVes = Math.abs(optionBcv_Ves - optionAvg_Ves);
            const diffUsd = Math.abs(optionBcv_Usd - optionAvg_Usd);
            const minVes = Math.min(optionBcv_Ves, optionAvg_Ves);
            const maxVes = Math.max(optionBcv_Ves, optionAvg_Ves);
            const diffPerc = (maxVes > 0) ? (diffVes / maxVes) * 100 : 0;
            
            const vesFormat = (val) => val.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' Bs';
            
            // Modificado para obtener el valor formateado sin la sigla '$'
            const usdFormatNoSymbol = (val) => val.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            const percFormat = (val) => val.toFixed(2); 
            
            if (optionAvg_Ves < optionBcv_Ves) {
                // El precio con Tasa Promedio es más bajo (Pagar en Dólares Físicos/Promedio es mejor)
                const color = 'text-yellow-400';
                box.classList.add('border-yellow-500', 'bg-yellow-900/20'); 
                
                // AJUSTE DE TEXTO 1
                verdict.textContent = "Dólares Físicos"; 
                verdict.classList.add('text-yellow-400');
                
                // AJUSTE DE TEXTO 2 (Flecha y sintaxis)
                savings.innerHTML = `
                    **El costo es menor usando la Tasa Promedio**
                    <span class="text-xs block mt-1">
                        Ahorro Total: 
                        <span class="text-yellow-300">${vesFormat(diffVes)}</span>
                        <br/>(aprox. <span class="${color}">$ ${usdFormatNoSymbol(diffUsd)}</span>) 
                        <span class="font-bold">→</span>
                        <span class="${color} text-xs"> ${percFormat(diffPerc)}% menos</span>.
                    </span>
                    <span class="text-[10px] block mt-1">
                        (BCV: ${vesFormat(optionBcv_Ves)} | Promedio: ${vesFormat(optionAvg_Ves)})
                    </span>
                `;
            } else if (optionBcv_Ves < optionAvg_Ves) {
                // El precio con Tasa BCV es más bajo (Pagar en Bolívares/BCV es mejor)
                const color = 'text-green-400';
                box.classList.add('border-green-500', 'bg-green-900/20'); 
                
                // AJUSTE DE TEXTO 1
                verdict.textContent = "Bolívares";
                verdict.classList.add('text-green-400');
                
                // AJUSTE DE TEXTO 2 (Flecha y sintaxis)
                savings.innerHTML = `
                    **El costo es menor usando la Tasa Oficial**
                    <span class="text-xs block mt-1">
                        Ahorro Total: 
                        <span class="text-green-300">${vesFormat(diffVes)}</span>
                        <br/>(aprox. <span class="${color}">$ ${usdFormatNoSymbol(diffUsd)}</span>) 
                        <span class="font-bold">→</span>
                        <span class="${color} text-xs"> ${percFormat(diffPerc)}% menos</span>.
                    </span>
                     <span class="text-[10px] block mt-1">
                        (BCV: ${vesFormat(optionBcv_Ves)} | Promedio: ${vesFormat(optionAvg_Ves)})
                    </span>
                `;
            } else {
                // Precios iguales
                box.classList.add('border-slate-600');
                verdict.textContent = "Indistinto";
                verdict.classList.add('text-white');
                savings.textContent = `La diferencia es menor a 0.01 Bs, ambas opciones son igualmente convenientes.`;
            }
        }

        // --- Event Listeners ---

        // Función de manejo para cambios en las tasas (BCV, P2P)
        const handleRateChange = () => {
            updateDiff();
            recalculateAvg();
            updateConversions(); // Recalcula conversiones al cambiar la tasa
            saveState();
        };
        
        // Manejador para el cambio de un input bidireccional
        const handleBiDirectionalChange = (event) => {
            // Llama a updateConversions para actualizar el campo vinculado, el análisis y el guardado
            updateConversions(event.target.id); 
        };

        // 1. Detectar cambios manuales en BCV y Tasa P2P
        ['input', 'keyup'].forEach(evt => {
            els.bcvDisplay.addEventListener(evt, handleRateChange);
            els.usdtDisplay.addEventListener(evt, handleRateChange);
        });
        
        // 2. Detectar cambios en los 4 inputs bidireccionales (Precio)
        ['input', 'keyup'].forEach(evt => {
            els.price_bcv_usd_input.addEventListener(evt, handleBiDirectionalChange);
            els.price_bcv_ves_input.addEventListener(evt, handleBiDirectionalChange);
            els.price_avg_usd_input.addEventListener(evt, handleBiDirectionalChange);
            els.price_avg_ves_input.addEventListener(evt, handleBiDirectionalChange);
        });

        // 3. Permitir editar la tasa promedio manualmente (sobreescribe el cálculo)
        els.avgRateInput.addEventListener('input', (e) => {
            state.manualOverrideAvg = true; 
            state.avgRate = parseFloat(e.target.value);
            // Al cambiar la tasa promedio, se deben recalcular todas las conversiones
            updateConversions(); 
            saveState();
        });

        // 4. Botón Reiniciar
        els.btnReset.addEventListener('click', () => {
            // 1. Limpiar campos de precios (UI)
            els.price_bcv_usd_input.value = '';
            els.price_bcv_ves_input.value = '';
            els.price_avg_usd_input.value = '';
            els.price_avg_ves_input.value = '';
            
            // 2. Resetear análisis y override
            els.resultCard.classList.add('hidden');
            state.manualOverrideAvg = false;
            
            // 3. Fetch nuevas tasas (sobrescribe BCV/P2P con datos frescos/fallback)
            fetchRates();
        });

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Cargar el estado guardado (para valores de fallback)
            loadSavedState(); 
            // 2. Intentar obtener tasas frescas de la API
            fetchRates();
        });

    </script>
</body>
</html>
